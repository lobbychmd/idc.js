var mongoose = require('mongoose');
require('mongo');

exports.login = function login(req, res, next) {
    if (!req.session["user"] ){
        res.redirect("/login?rel=" + req.url.toString());
    }
    else {
        mongoose.model("Account").find({Guest: false /*"Friends.$id": req.session.user._id*/ }, function (err, fs) {
            var as = [];
            for(var j in fs){
                as.push(fs[j]._id);
            }
            var projects = [];
            require('account').user_projects(req.session.user._id,function ( docs) {
                for (i in docs) {
                    projects.push({ name: docs[i]._id, value: docs[i].ProjectName });
                }
              //  projects.push({ name: '4f66d2146e435c0578079f75', value: '4f66d2146e435c0578079f75' });
                console.log(docs);
                if (!req.session.project) if (docs.length>0) req.session.project = docs[0]._id;
                req.global_data = { projects: projects, user: req.session.user, project: req.session.project };
                next();
            });
        });
    }
  };



exports.sync_auth = function login(req, res, next) {
    if (req.query.SyncPassword && req.query.ProjectCode) {  //根据安全代码验证
        mongoose.model("Project").findOne({ ProjectCode: req.query.ProjectCode, SyncPassword: req.query.SyncPassword }, function (err, doc) {
            if (doc) {
                req.params.ProjectName = doc._id;
                next();
            }
            else {
                res.send('error: Login failed.');
            }
        });
    }
    else if (req.query.UserNO && req.query.Password) { //根据登录信息代码验证，不推荐
        require("account").user_projects_by_user_no(req.query.UserNO, function (accounnt, prjs) {
            if (!prjs) res.send('error: Login failed.');
            else {
                for (var p in prjs) {  //指定项目
                    if (req.query.ProjectCode && (prjs[p].ProjectCode = req.query.ProjectCode)) {
                        req.params.ProjectName = doc.ProjectName;
                        next();
                    }                 //不指定项目就取自己的项目（也不推荐因为以后每个用户有多个项目）
                    else if (accounnt._id == prjs[p].Account) {
                        req.params.ProjectName = doc.ProjectName;
                        next();
                    }
                }
            }
        });
    } else res.send('error: Login failed.');
};

