function queryQueries(pv, table, field) {
    var r = [];
    if (pv['Queryies']) {
        var qs = pv['Queryies'].split(';');
        for (var i in qs)
            r.push(qs[i]);
    }
    for (var i in pv[table]) {
        var qs = pv[table][i][field].split('\r\n');
        for (var j in qs) 
            if (r.indexOf(qs[j]) < 0) r.push(qs[j]);
    }
    return r;
}

var queryParams = function (pv) {
    var fs = [];
    for (var i in pv.Scripts) {
        var reg = /select\s(.+)\sfrom/ig;
        var select_statement = reg.exec(pv.Scripts[i].Script.split('\r\n').join(' '));
        if (select_statement) {
            //console.log(select_statement[1]);
            reg = /(?:([a-zA-Z][a-zA-Z0-9_]+)\s*=|\sas\s([a-zA-Z][a-zA-Z0-9_]+))/ig;
            var r = reg.exec(select_statement[1]);
            while (r) {
                if (fs.indexOf(r[1]) < 0)
                    if (r[1]) fs.push(r[1]);
                r = reg.exec(pv.Scripts[i].Script);
            }
        }
    }
    return fs;
};

var metaTreeConfig = {
    "Root": {
        "text": "Root",
        "children": [
            { "type": "MetaProject", "query": { _id: "@ProjectName"} }
        ]
    }, "MetaProject": {
        "table": "Project",
        "text": "ProjectName",
        "children": [
            { "type": "ThemeGroup", "caption": "主题", "query": "" },
            { "type": "RootMenu.Menu", "caption": "模块", "query": "" },
            { "type": "ConnGroup", "caption": "数据连接", "query": "" },
            { "type": "RootA-Z.BizGroup", "caption": "业务逻辑", "query": "" },
            { "type": "RootA-Z.QueryGroup", "caption": "查询", "query": "" },
            { "type": "RootA-Z.FieldGroup", "caption": "数据字典", "query": "" },
            { "type": "SrvGroup", "caption": "服务接口", "query": "" }
        ]
    }, "ThemeGroup": {
        text: "caption", newType: { "type": "Theme", "inherite": "" },
        children: [{ type: "Theme", "query": {ProjectName: "@ProjectName"}}]
    },
    "Theme": {
        text: "Theme",
        table: "MetaTheme"
    },
    "SrvGroup": {
        text: "caption", newType: { "type": "Srv", "inherite": "" },
        children: [{ "type": "IdcSrvGroup", "caption": "内部服务", "query": "" },
                   { "type": "DataPublishGroup", "caption": "数据发布服务", "query": "" },
                   { "type": "ExternalSrvGroup", "caption": "外部服务", "query": "" },
                   { "type": "SrvQueueGroup", "caption": "数据订阅服务", "query": "" } ]
    },
    IdcSrvGroup: {
        text: 'caption',
        children: [{ "type": "QuerySrvGroup", "caption": "查询服务", "query": "" },
                   { "type": "BizSrvGroup", "caption": "业务逻辑服务", "query": "" }]
    },
    "QuerySrvGroup": {
        text: "caption",
        newType: { "type": "QuerySrv", "SrvType": "Query" },
        children: [{ type: "QuerySrv", "query": {ProjectName: "@ProjectName", SrvType:"Query"}}]
    },
    "QuerySrv": {
        text: "Name",
        table: "MetaQuerySrv"
    },
    "BizSrvGroup": {
        text: "caption",
        newType: { "type": "BizSrv" },
        children: [{ type: "BizSrv", "query": {ProjectName: "@ProjectName", SrvType:"Biz"}}]
    },
    "BizSrv": {
        text: "Name",
        table: "MetaBizSrv"
    },
    "SrvQueueGroup": {
        text: "caption",
        newType: { "type": "SrvQueue", "inherite": "" },
        children: [{ type: "SrvQueue", "query": {ProjectName: "@ProjectName"}}]
    },
    "SrvQueue": {
        text: "Name",
        table: "MetaDataSubscribeSrv"
    },
    DataPublishGroup:{
        text: "caption",
        newType:{type: "DataPublishSrv"},
        children: [{ type: "DataPublishSrv", "query": {ProjectName: "@ProjectName"}}]
    },
    DataPublishSrv:{
        table: "MetaDataPublishSrv",
        text:"Name"
    },
    ExternalSrvGroup:{
        text: "caption",
        newType:{type: "ExternalSrv"},
        children: [{ type: "ExternalSrv", "query": {ProjectName: "@ProjectName"}}]
    },
    ExternalSrv:{
        table: "MetaExternalSrv",
        text:"Name"
    },
    "ConnGroup": {
        text: "caption", newType: { "type": "Connection", "inherite": "" },
        children: [{ type: "Connection", "query": {ProjectName: "@ProjectName"}}]
    },
    "Connection": {
        text: "Alias",
        table: "MetaConnection"
    },
    "RootA-Z": {
        "text": "caption",
        "children": [{ "query": "@A-Z" }]
    }, "RootMenu": {
        "text": "caption",
        "newType": { "type": "MetaModule", "inherite": {ParentID: ""} },
        "children": [{ "caption": "", "query": { "$or": [{ ParentID: '' }, { ParentID: null }], ProjectName: "@ProjectName" } }]
    }, "BizGroup": {
        "text": "caption", "newType": { "type": "MetaBiz", "inherite": "" },
        "children": [
                { "type": "MetaBiz", "query": { ProjectName: "@ProjectName", BizID: function (pv) { return new RegExp("^" + pv["@subType"] ); } } }
            ]
    }, "FieldGroup": {
        "text": "caption",
        "newType": { "type": "MetaField", "inherite": "" },
        "children": [{ "type": "MetaField", "query": { ProjectName: "@ProjectName", FieldName: function (pv) { return new RegExp("^" + pv["@subType"] ); } } }]
    }, "QueryGroup": {
        "text": "caption",
        "newType": { "type": "MetaQuery", "inherite": "" },
        "children": [{ "type": "MetaQuery", "query": { ProjectName: "@ProjectName", QueryName: function (pv) { return new RegExp("^" + pv["@subType"] ); } } }]
    }, "Menu": {
        "table": "MetaModule",
        "text": "Caption",
        "newType": { "type": "MetaModule", "inherite": { ParentID: "@ModuleID" } },
        "children": [
            { "type": "MetaModule", "query": { ParentID: "@ModuleID", Path: /./, ProjectName: "@ProjectName" } },
            { "type": "Menu", "query": { ParentID: "@ModuleID", "$or": [{ Path: '' }, {Path: null}], ProjectName: "@ProjectName" } }
        ]
    }, "MetaModule": {
        "table": "MetaModule",
        "text": "Caption",
        "children": [
            { "type": "ModuleBizGroup", "caption": "业务逻辑", "query": "" },
            { "type": "ModuleQueryGroup", "caption": "查询", "query": "" },
            { "type": "ModuleFuncGroup", "caption": "模块权限", "query": "" }]
    }, "ModuleBizGroup": {
        "parent": "MetaModule",
        "text": "caption", "newType": { "type": "MetaBiz", "inherite": "" },
        "children": [
            { "type": "MetaBiz", "query": { ProjectName: "@ProjectName", BizID: { "$in": "@Bizes" } } }
        ]
    }, "ModuleQueryGroup": {
        "parent": "MetaModule",
        "text": "caption",
        "newType": { "type": "MetaQuery", "inherite": "" },
        "children": [
            //{ "type": "MetaQuery", "query": { ProjectName: "@ProjectName", QueryName: { "$in": "@ModulePages.Queries" } } }
            {
                "type": "MetaQuery", "query": {
                    ProjectName: "@ProjectName", QueryName: {
                        "$in": function (pv) { return queryQueries(pv, "ModulePages", "Queries"); }
                    }
                }
            }
        ]
    }, "ModuleFuncGroup": {
        "parent": "MetaModule",
        "text": "caption",
        "multiEdit": true,
        "newType": { "type": "MetaFunction", "inherite": "" },
        "children": [
            { "type": "MetaFunction", "query": {ProjectName: "@ProjectName", FuncID:{"$in": "@Functions.FuncID"}} }
        ]
    }, "MetaFunction": {
        "text": "FuncID",
        "table": "MetaFunction"
    }, "MetaBiz": {
        "table": "MetaBiz",
        "newType": { "type": "MetaField", "inherite": "ParentID=ModuleID" },
        "text": "BizID"
    }, "MetaQuery": {
        "table": "MetaQuery",
        "text": "QueryName",
        "children": [
            { "type": "MetaQueryFields", "caption": "字段", "query": "" },
            { "type": "MetaQueryParams", "caption": "参数", "query": "" }
        ]
    }, "MetaQueryFields": {
        "text": "caption",
        "parent": "MetaQuery",
        "multiEdit": true,
        "newType": { "type": "MetaField", "inherite": { Context: "@QueryName" } },
        "children": [
            {
                "type": "MetaField", "query": {
                    ProjectName: "@ProjectName", Context: { "$in": ["@(QueryName)", null, ""] }, FieldName: {
                        "$in": queryParams
                    }
                }, "fullList": { FieldName: queryParams}
            }
        ]
    }, "MetaQueryParams": {
        "text": "caption",
        "parent": "MetaQuery",
        "multiEdit": true,
        "newType": { "type": "MetaField", "inherite": { Context: "@(QueryName)_p" } },
        "children": [
            {
                "type": "MetaField",
                "query": { ProjectName: "@ProjectName", Context: "@(QueryName)_p", FieldName: { "$in": "@Params.ParamName" } },
                "fullList": { FieldName: "@Params.ParamName" }
            }
        ]
    }, "MetaField": {
        "table": "MetaField", "text": "FieldName"
    }
}

exports.metaTreeConfig = metaTreeConfig;
exports.metaTreeTypes = ["Theme","MetaProject", "MetaModule", "MetaQuery", "MetaBiz", "MetaField", "MetaFunction", "Menu",
    "DataPublishSrv", "ExternalSrv", "SrvQueue", "DataPublishSrv", "ExternalSrv"];

exports.metaKeys = {
    "MetaModule": ["ProjectName", "ModuleID"],
    "MetaTheme": ["ProjectName", "Theme"],
    "MetaTheme": ["ProjectName", "Alias"],
    "MetaFunction": ["ProjectName", "FuncID"],
    "MetaQuery": ["ProjectName", "QueryName"], 
    "MetaBiz": ["ProjectName", "BizID"],  
    "MetaField": ["ProjectName", "FieldName", {name: "Context", nullable: true}],  
    "MetaFunction":["ProjectName", "FuncID"],

    "DataPublishSrv": ["ProjectName", "SrvCode"],
    "ExternalSrv": ["ProjectName", "SrvCode"],
    "SrvQueue": ["ProjectName", "SrvCode"],
    "DataPublishSrv": ["ProjectName", "SrvCode"],
    "ExternalSrv": ["ProjectName", "SrvCode"]
};

