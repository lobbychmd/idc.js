var _ = require("underscore")

function queryQueries(pv, table, field) {
    var r = [];
    for (var i in pv[table]) {
        var qs = pv[table][i][field].split(';');
        
        for (var j in qs) 
            if (r && r.indexOf(qs[j].trim()) < 0) r.push(qs[j].trim());
    }
    return r;
}

function queryLookupQueries(pv) {
    var r = [];
    for (var i in pv["ModulePages"]) {
        var qs = pv["ModulePages"][i]["PageLookup"].trim();
        
        if (qs) {
            try {
                var flow = eval("(" + qs + ")");
                for (var j in flow) {
                    var q1 = flow[j]["LookupQuery"];
                    if (q1 && r && r.indexOf(q1) < 0) r.push(q1);

                    var q2 = flow[i]["SearchQuery"];
                    if (q2 && r && r.indexOf(q2) < 0) r.push(q2);
                }
            } catch (e) {
                console.log(e);
                console.log(qs);
            }

              
        }
        
    }
    return r;
}

function queryFlowBizes(pv) {
    var r = [];
    for (var i in pv["ModulePages"]) {
        var qs = pv["ModulePages"][i]["PageFlow"].trim();
        
        if (qs) {
            try {
                var flow = eval("(" + qs + ")");
                for (var j in flow) {
                    var q1 = flow[j]["SaveBiz"];
                    if (q1 && r && r.indexOf(q1) < 0) r.push(q1);

                    var q2 = flow[j]["Action"];
                    
                    for (var k in q2) { 
                        //
                        if (q2[k]["Biz"] && r && r.indexOf(q2[k]["Biz"]) < 0) {
                           // console.log(q2[k]["Biz"]);
                            r.push(q2[k]["Biz"]);
                        }
                    }
                }
            } catch (e) {
                console.log(e);
                console.log(qs);
            }

              
        }
        
    }
    return r;
}

var queryParams = function (pv) {
    var fs = [];
    for (var i in pv.Scripts) {
        var reg = /select\s(.+)\sfrom/ig;
        var select_statement = reg.exec(pv.Scripts[i].Script.split('\r\n').join(' ').split('\n').join(' '));
        //console.log(pv.Scripts[i].Script.split('\r\n'));
        if (select_statement) {
            reg = /(?:([a-zA-Z][a-zA-Z0-9_]+)\s*=|\sas\s([a-zA-Z][a-zA-Z0-9_]+))/ig;
            var r = reg.exec(select_statement[1]);
            while (r) {
                if (fs.indexOf(r[1]) < 0)
                    if (r[1]) fs.push(r[1]);
                r = reg.exec(pv.Scripts[i].Script);
            }
        }
    }
    if (fs.length > 0) {
        return fs;
    } else {
        require("simulate").MetaQuery(pv.ProjectName, pv.QueryName, function (data) {
            console.log(data);
            _.each(eval("(" + data + ")").Schema, function (k) {
                _.each(k, function (j) {
                    fs.push(j.ColumnName);
                });
            });

            return fs;
        });
    }
};

var metaTreeConfig = {
    "Root": {
        "text": "Root",
        "children": [
            { "type": "MetaProject", "query": { _id: "@ProjectName"} }
        ]
    }, "MetaProject": {
        "table": "Project",
        "text": "ProjectName",
        "children": [
            { "type": "RootA-Z.TableGroup", "caption": "数据结构", "query": "" },
            { "type": "ThemeGroup", "caption": "主题", "query": "" },
            { "type": "RootMenu.Menu", "caption": "模块", "query": "" },
            { "type": "ConnGroup", "caption": "数据连接", "query": "" },
            { "type": "RootA-Z.BizGroup", "caption": "业务逻辑", "query": "" },
            { "type": "RootA-Z.QueryGroup", "caption": "查询", "query": "" },
            { "type": "RootA-Z.FieldGroup", "caption": "数据字典", "query": "" },
            { "type": "SrvGroup", "caption": "服务接口", "query": "" }
        ]
    }, "ThemeGroup": {
        text: "caption", newType: { "type": "Theme", "inherite": "" },
        children: [{ type: "Theme", "query": {ProjectName: "@ProjectName"}}]
    },
    "Theme": {
        text: "Theme",
        table: "MetaTheme"
    },
    "SrvGroup": {
        text: "caption", newType: { "type": "Srv", "inherite": "" },
        children: [{ "type": "IdcSrvGroup", "caption": "内部服务", "query": "" },
                   { "type": "DataPublishGroup", "caption": "数据发布服务", "query": "" },
                   { "type": "BizSrvGroup", "caption": "业务逻辑服务", "query": "" },
                   { "type": "ExternalSrvGroup", "caption": "外部服务", "query": "" },
                   { "type": "SrvQueueGroup", "caption": "数据订阅服务", "query": "" } ]
    },
    IdcSrvGroup: {
        text: 'caption',
        children: [/*{ "type": "QuerySrvGroup", "caption": "查询服务", "query": "" },
                    { "type": "BizSrvGroup", "caption": "业务逻辑服务", "query": "" }*/]
    },
    "QuerySrvGroup": {
        text: "caption",
        newType: { "type": "QuerySrv", "SrvType": "Query" },
        children: [{ type: "QuerySrv", "query": {ProjectName: "@ProjectName", SrvType:"Query"}}]
    },
    //"QuerySrv": {
    //    text: "Name",
    //    table: "MetaQuerySrv"
    //},
    "BizSrvGroup": {
        text: "caption",
        newType: { "type": "BizSrv" },
        children: [{ type: "BizSrv", "query": {ProjectName: "@ProjectName"}}]
    },
    "BizSrv": {
        text: "Name",
        table: "MetaBizSrv"
    },
    "SrvQueueGroup": {
        text: "caption",
        newType: { "type": "SrvQueue", "inherite": "" },
        children: [{ type: "SrvQueue", "query": {ProjectName: "@ProjectName"}}]
    },
    "SrvQueue": {
        text: "Name",
        table: "MetaDataSubscribeSrv"
    },
    DataPublishGroup:{
        text: "caption",
        newType:{type: "DataPublishSrv"},
        children: [{ type: "DataPublishSrv", "query": {ProjectName: "@ProjectName"}}]
    },
    DataPublishSrv:{
        table: "MetaDataPublishSrv",
        text:"Name"
    },
    ExternalSrvGroup:{
        text: "caption",
        newType:{type: "ExternalSrv"},
        children: [{ type: "ExternalSrv", "query": {ProjectName: "@ProjectName"}}]
    },
    ExternalSrv:{
        table: "MetaExternalSrv",
        text:"Name"
    },
    "ConnGroup": {
        text: "caption", newType: { "type": "Connection", "inherite": "" },
        children: [{ type: "Connection", "query": {ProjectName: "@ProjectName"}}]
    },
    "Connection": {
        text: "Alias",
        table: "MetaConnection"
    },
    "RootA-Z": {
        "text": "caption",
        "children": [{ "query": "@A-Z" }]
    }, "RootMenu": {
        "text": "caption",
        "newType": { "type": "MetaModule", "inherite": {ParentID: ""} },
        "children": [{ "caption": "", "query": { "$or": [{ ParentID: '' }, { ParentID: null }], ProjectName: "@ProjectName" } }]
    }, "BizGroup": {
        "text": "caption", "newType": { "type": "MetaBiz", "inherite": "" },
        "children": [
                { "type": "MetaBiz", "query": { ProjectName: "@ProjectName", BizID: function (pv) { return new RegExp("^" + pv["@subType"] ); } } }
            ]
    }, "FieldGroup": {
        "text": "caption",
        "newType": { "type": "MetaField", "inherite": "" },
        "children": [{ "type": "MetaField", "query": { ProjectName: "@ProjectName", FieldName: function (pv) { return new RegExp("^" + pv["@subType"] ); } } }]
    }, "QueryGroup": {
        "text": "caption",
        "newType": { "type": "MetaQuery", "inherite": "" },
        "children": [{ "type": "MetaQuery", "query": { ProjectName: "@ProjectName", QueryName: function (pv) { return new RegExp("^" + pv["@subType"] ); } } }]
    }, "Menu": {
        "table": "MetaModule",
        "text": "Caption",
        "newType": { "type": "MetaModule", "inherite": { ParentID: "@ModuleID" } },
        "children": [
            { "type": "MetaModule", "query": { ParentID: "@ModuleID", "$or": [{ Path: /./}, {Type: 'module'}, {Type: null}] , ProjectName: "@ProjectName" } },
            { "type": "Menu", "query": { ParentID: "@ModuleID", "$or": [{ Path: '' }, {Path: null}, {Type: 'menu'}], ProjectName: "@ProjectName" } }
        ]
    }, "MetaModule": {
        "table": "MetaModule",
        "text": "Caption",
        "children": [
            { "type": "ModuleBizGroup", "caption": "业务逻辑", "query": "" },
            { "type": "ModuleQueryGroup", "caption": "查询", "query": "" },
            { "type": "ModuleFuncGroup", "caption": "模块权限", "query": "" }]
    }, "ModuleBizGroup": {
        "parent": "MetaModule",
        "text": "caption", "newType": { "type": "MetaBiz", "inherite": "" },
        "children": [
            {
                "type": "MetaBiz", "query": {
                    ProjectName: "@ProjectName", BizID: {
                        "$in": function (pv) { return queryFlowBizes(pv); }
                    }
                }
            }
        ]
    }, "ModuleQueryGroup": {
        "parent": "MetaModule",
        "text": "caption",
        "newType": { "type": "MetaQuery", "inherite": "" },
        "children": [
            //{ "type": "MetaQuery", "query": { ProjectName: "@ProjectName", QueryName: { "$in": "@ModulePages.Queries" } } }
            {
                "type": "MetaQuery", "query": {
                    ProjectName: "@ProjectName", QueryName: {
                        "$in": function (pv) { return queryQueries(pv, "ModulePages", "Queries").concat(queryLookupQueries(pv)); }
                    }
                }
            }
        ]
    }, "ModuleFuncGroup": {
        "parent": "MetaModule",
        "text": "caption",
        "multiEdit": true,
        "newType": { "type": "MetaFunction", "inherite": "" },
        "children": [
            { "type": "MetaFunction", "query": {ProjectName: "@ProjectName", FuncID:{"$in": "@Functions.FuncID"}} }
        ]
    }, "MetaFunction": {
        "text": "FuncID",
        "table": "MetaFunction"
    }, "MetaBiz": {
        "table": "MetaBiz",
        "newType": { "type": "MetaField", "inherite": "ParentID=ModuleID" },
        "text": "BizID"
    }, "MetaQuery": {
        "table": "MetaQuery",
        "text": "QueryName",
        "children": [
            { "type": "MetaQueryFields", "caption": "字段", "query": "" },
            { "type": "MetaQueryParams", "caption": "参数", "query": "" }
        ]
    }, "MetaQueryFields": {
        "text": "caption",
        "parent": "MetaQuery",
        "multiEdit": true,
        "newType": { "type": "MetaField", "inherite": { Context: "@QueryName" } },
        "children": [
            {
                "type": "MetaField", "query": {
                    ProjectName: "@ProjectName", Context: { "$in": ["@(QueryName)", null, ""] }, FieldName: {
                        "$in": queryParams
                    }
                }, "fullList": { FieldName: queryParams}
            }
        ]
    }, "MetaQueryParams": {
        "text": "caption",
        "parent": "MetaQuery",
        "multiEdit": true,
        "newType": { "type": "MetaField", "inherite": { Context: "@(QueryName)_p" } },
        "children": [
            {
                "type": "MetaField",
                "query": { ProjectName: "@ProjectName", Context: "@(QueryName)_p", FieldName: { "$in": "@Params.ParamName" } },
                "fullList": { FieldName: "@Params.ParamName" }
            }
        ]
    }, "MetaField": {
        "table": "MetaField", "text": ["FieldName", "Context"]
    },
    "TableGroup": {
        "text": "caption", "newType": { "type": "MetaTable", "inherite": "" },
        "children": [
                { "type": "MetaTable", "query": { ProjectName: "@ProjectName", TableName: function (pv) { return new RegExp("^\\w" + pv["@subType"] ); } } }
            ]
    }, 
    "MetaTable": {
        "table": "MetaTable", "text": "TableName"
    } 
}

exports.metaTreeConfig = metaTreeConfig;
exports.metaTreeTypes = _.keys(metaTreeConfig);

//下面的key 是集合名(表名）
exports.metaKeys = {
    "MetaModule": ["ProjectName", "ModuleID"],
    "MetaTheme": ["ProjectName", "Theme"],
    "MetaConnection": ["ProjectName", "Alias"],
    "MetaFunction": ["ProjectName", "FuncID"],
    "MetaQuery": ["ProjectName", "QueryName"], 
    "MetaBiz": ["ProjectName", "BizID"],  
    "MetaField": ["ProjectName", "FieldName", {name: "Context", nullable: true}],  
    "MetaFunction":["ProjectName", "FuncID"],
    "MetaTable":["ProjectName", "TableName"],

    "MetaDataPublishSrv": ["ProjectName", "SrvCode"],
    "MetaDataSubscribeSrv": ["ProjectName", "SrvCode"],
    "MetaBizSrv": ["ProjectName", "SrvCode"],
    "MetaExternalSrv": ["ProjectName", "SrvCode"],
    MetaTable: ["ProjectName", "TableName"]
};

