var mongoose = require('mongoose');
var tree_config = require('tree_config').metaTreeConfig;
var js_utils = require('js_utils').utils;
//var $ = require('jquery');

var validateType = {
    last_update: {
        message: '数据已经更改过，请重新获取', validate: function (value, doc, type, _id, callback) {
            var m = mongoose.model(type);
            m.findOne({ _id: _id }, function (err, doc1) {
                if (doc1) {
                    callback((!doc.LastUpdateTime && !doc1.LastUpdateTime) || (new Date(doc.LastUpdateTime).toUTCString() == doc1.LastUpdateTime.toUTCString()));
                }
                else callback(true);
            });
            return null; //必须返回ｎｕｌｌ，　让调用者等待回调
        }
    },
    require: { message: '不能为空', validate: function (v) { return !!v || v === 0; } },
    parent_module: {
        message: '父节点不存在', validate: function (value, doc, type, _id, callback) {
            var m = mongoose.model("MetaModule");
            m.findOne({ ModuleID: value,ProjectName: doc['ProjectName'] }, function (err, doc1) {
                callback(!!doc1);
            })
            return null;
        }
    },
    parent_module_dead: {
        message: '父节点死循环了', validate: function (value, doc, type, _id, callback) {
            return null;
        }
    },
    conn_not_defined: {
        message: '数据连接未定义', validate: function (value, doc, type, _id, callback) {
            if (value){
                var m = mongoose.model("MetaConnection");
                m.findOne({ Alias: value, ProjectName: doc['ProjectName'] }, function (err, doc1) {
                    callback(!!doc1);
                })
                return null;
            } else callback(true);
        }
    },
}

var validateConfig = {
    "MetaModule.LastUpdateTime": ["last_update"],
    "MetaModule.ModuleID": ["require"],
    //"MetaModule.ParentID": ["require", "parent_module"],
    "MetaModule.ParentID": ["parent_module"],
    "MetaModule.Caption": ["require"],
    "MetaQuery.QueryName": ["require"],
    "MetaQuery.ConnAlias": ["conn_not_defined"],
    "MetaQuery.Params.ParamName": ["require"],
}

var getherValids = function (type, prefix, obj, _id, errCheck) {

    for (var i in obj) {
        if (obj[i].constructor === Array) {
            for (var j in obj[i]) {
                ///console.log(obj[i][j]);
                getherValids(type, prefix + "." + i, obj[i][j], _id, errCheck);
            }
        }
        else {
            var path = prefix + "." + i;
            for (var j in validateConfig) {
                if (path === j) {
                    for (var k in validateConfig[j]) {
                        var vtype = validateConfig[j][k];
                        errCheck.push({ func: validateType[vtype].validate, fields: i, msg: j + validateType[vtype].message, params: [obj[i], obj, type, _id] });
                    }
                    break;
                }
            }
        }
    }
}
var validateModel = function (type, obj, _id, callback) {
    var errCheck = [];
    getherValids(type, type, obj, _id,errCheck);
    
    var r = { Errors: [] };
    js_utils.each_exec(errCheck,
        function (child, next) {
            var check = child.func(child.params[0], child.params[1], child.params[2], child.params[3], function (ok) {
                if (!ok) r.Errors.push({ ErrorMessage: child.msg, MemberNames: [child.fields] });
                next();
            });
            if (check == null);
            else{
                if (!check) r.Errors.push({ ErrorMessage: child.msg, MemberNames: [child.fields] });
                next();
            }
        },
        function () {
            r.IsValid = r.Errors.length == 0;
            callback(r);
        }, 0);
    
    return r;
}


exports.save = function (type, _id, doc, callback) {
    var m = mongoose.model(tree_config[type].table);
    console.log(tree_config[type].table);
    _id = _id ? _id : doc._id;
    validateModel(tree_config[type].table, doc, _id, function (r) {
        doc.LastUpdateTime = new Date();
        r.ReturnValues = { _id: _id };
        if (r.IsValid) {
            if (_id) {
                //console.log(doc);
                doc = JSON.parse( JSON.stringify( new m(doc)));
                delete doc["_id"];
                
                m.update({ _id: _id }, doc, function (err, numAffected) {
                    if (err) r.Errors.push({ ErrorMessage: JSON.stringify(err) });
                    callback(r);
                });

            } else {
                doc._id = require('mongodb').BSONPure.ObjectID();
                r.ReturnValues["_id"] = doc._id;
                doc = new m(doc);
                //}
                doc.save(function (err, numAffected) {
                    if (err) r.Errors.push({ErrorMessage: JSON.stringify(err)});
                    callback(r);
                });
            }
        } else callback(r);
    });
    
}


exports.remove = function (type, _id, doc, callback) {
    var m = mongoose.model(tree_config[type].table);
    console.log(doc);
    m.findOne({ _id: _id ? _id : doc._id }, function (err, doc) {
        doc.remove(function (err1, numAffected) {
            var Recyle = mongoose.model("Recyle");
            new Recyle({ Collection: tree_config[type].table, Doc: doc, At: new Date() }).save();
            callback(err1, numAffected);
        });
        
    })
    
}
